{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load website_tags %}

{% block title %}{% if form.instance.pk %}编辑网站{% else %}添加网站{% endif %} - 控制面板{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% if form.instance.pk %}编辑网站{% else %}添加网站{% endif %}</h5>
                </div>
                <div class="card-body">
                    <form method="post" class="form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">网站名称</label>
                            {{ form.name }}
                            <div class="form-text">网站的名称，仅用于后台管理</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">域名</label>
                            {{ form.domain }}
                            <div class="form-text">网站的访问域名，例如：www.example.com</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">服务器类型</label>
                            {{ form.server_type }}
                            <div class="form-text">选择网站使用的Web服务器类型</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">端口</label>
                            <input type="number" name="port" class="form-control" value="{{ form.instance.port|default:'80' }}" min="1" max="65535">
                            <div class="form-text">网站访问端口，默认80</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">PHP版本</label>
                            <select name="php_version" class="form-control">
                                <option value="">不使用PHP</option>
                                {% for version in installed_php_versions %}
                                <option value="{{ version }}" {% if website.php_version == version %}selected{% endif %}>
                                    PHP {{ version }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">选择网站使用的PHP版本</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SSL 证书</label>
                            <select name="ssl_provider" class="form-control" id="ssl-provider">
                                <option value="none" {% if form.instance.ssl_provider == 'none' %}selected{% endif %}>不使用 SSL</option>
                                <option value="cloudflare" {% if form.instance.ssl_provider == 'cloudflare' %}selected{% endif %}>Cloudflare</option>
                                <option value="letsencrypt" {% if form.instance.ssl_provider == 'letsencrypt' %}selected{% endif %}>Let's Encrypt</option>
                            </select>
                            <div class="form-text">选择 SSL 证书提供商</div>
                        </div>

                        <!-- SSL 配置选项和操作按钮 -->
                        <div id="ssl-operations" class="mb-3" {% if form.instance.ssl_provider == 'none' %}style="display: none;"{% endif %}>
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3">SSL 证书管理</h6>
                                    
                                    <!-- Let's Encrypt 配置部分 -->
                                    <div id="letsencrypt-section" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">验证方式</label>
                                            <select name="le_validation" class="form-control" id="le-validation">
                                                <option value="http">HTTP 验证</option>
                                                <option value="dns">DNS 验证</option>
                                            </select>
                                            <div class="form-text">选择域名所有权验证方式</div>
                                        </div>
                                        
                                        <!-- DNS 验证说明 -->
                                        <div id="dns-validation-info" class="alert alert-info mt-3" style="display: none;">
                                            <h6><i class="fas fa-info-circle"></i> DNS 验证说明</h6>
                                            <div id="dns-records" class="mt-3">
                                                <div class="text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    <p class="mt-2">正在获取 DNS 验证记录...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cloudflare 配置部分 -->
                                    <div id="cloudflare-section" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">证书文件 (CRT)</label>
                                            <input type="file" name="cloudflare_cert" class="form-control" accept=".crt,.pem">
                                            <div class="form-text">上传 Cloudflare 颁发的证书文件</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">私钥文件 (KEY)</label>
                                            <input type="file" name="cloudflare_key" class="form-control" accept=".key">
                                            <div class="form-text">上传证书对应的私钥文件</div>
                                        </div>
                                    </div>

                                    <!-- 证书操作按钮 -->
                                    <div class="mt-3">
                                        {% if form.instance.pk %}
                                            {% if not form.instance.ssl_enabled or cert_info.status == 'error' %}
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-success" onclick="applyCertificate('{% url "website_ssl_apply" form.instance.pk %}')">
                                                    <i class="fas fa-plus"></i> 申请证书
                                                </button>
                                                <button type="button" class="btn btn-warning" onclick="renewCertificate('{% url "website_ssl_renew" form.instance.pk %}')">
                                                    <i class="fas fa-sync"></i> 更新证书
                                                </button>
                                                <button type="button" class="btn btn-danger" onclick="revokeCertificate('{% url "website_ssl_revoke" form.instance.pk %}')">
                                                    <i class="fas fa-times"></i> 删除证书
                                                </button>
                                            </div>
                                            {% else %}
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-warning" onclick="renewCertificate('{% url "website_ssl_renew" form.instance.pk %}')">
                                                    <i class="fas fa-sync"></i> 更新证书
                                                </button>
                                                <button type="button" class="btn btn-danger" onclick="revokeCertificate('{% url "website_ssl_revoke" form.instance.pk %}')">
                                                    <i class="fas fa-times"></i> 删除证书
                                                </button>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="additional-domains">
                            <label class="form-label">附加域名</label>
                            <div class="domain-list">
                                <!-- 动态添加的域名输入框将显示在这里 -->
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addDomainField()">
                                <i class="fas fa-plus"></i> 添加域名
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">保存</button>
                            <a href="{% url 'website_list' %}" class="btn btn-secondary">取消</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
function addDomainField() {
    const domainList = document.querySelector('.domain-list');
    const domainGroup = document.createElement('div');
    domainGroup.className = 'input-group mb-2';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'additional_domains[]';
    input.className = 'form-control';
    input.placeholder = '请输入域名';
    
    const btnGroup = document.createElement('div');
    btnGroup.className = 'input-group-append';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = function() {
        domainGroup.remove();
    };
    
    domainGroup.appendChild(input);
    domainGroup.appendChild(btnGroup);
    btnGroup.appendChild(removeBtn);
    domainList.appendChild(domainGroup);
}

// 如果是编辑模式，加载现有的附加域名
{% if form.instance.pk %}
{% for domain in form.instance.additional_domains.all %}
document.addEventListener('DOMContentLoaded', function() {
    const domainList = document.querySelector('.domain-list');
    const domainGroup = document.createElement('div');
    domainGroup.className = 'input-group mb-2';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'additional_domains[]';
    input.className = 'form-control';
    input.value = '{{ domain.domain }}';
    
    const btnGroup = document.createElement('div');
    btnGroup.className = 'input-group-append';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = function() {
        domainGroup.remove();
    };
    
    domainGroup.appendChild(input);
    domainGroup.appendChild(btnGroup);
    btnGroup.appendChild(removeBtn);
    domainList.appendChild(domainGroup);
});
{% endfor %}
{% endif %}

// SSL 提供商切换处理
document.getElementById('ssl-provider').addEventListener('change', function() {
    const sslOperations = document.getElementById('ssl-operations');
    const letsencryptSection = document.getElementById('letsencrypt-section');
    const cloudflareSection = document.getElementById('cloudflare-section');
    
    // 显示 SSL 操作区域
    sslOperations.style.display = this.value === 'none' ? 'none' : 'block';
    
    // 根据选择显示对应的配置部分
    if (this.value === 'letsencrypt') {
        letsencryptSection.style.display = 'block';
        cloudflareSection.style.display = 'none';
    } else if (this.value === 'cloudflare') {
        letsencryptSection.style.display = 'none';
        cloudflareSection.style.display = 'block';
    } else {
        letsencryptSection.style.display = 'none';
        cloudflareSection.style.display = 'none';
    }
});

// Let's Encrypt 验证方式切换
document.getElementById('le-validation')?.addEventListener('change', function() {
    const dnsInfo = document.getElementById('dns-validation-info');
    dnsInfo.style.display = this.value === 'dns' ? 'block' : 'none';
    
    if (this.value === 'dns' && '{{ form.instance.pk }}') {
        // 获取 DNS 验证记录
        fetch('{% url "website_ssl_dns_records" form.instance.pk %}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.records) {
                    const recordsDiv = document.getElementById('dns-records');
                    recordsDiv.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">DNS 记录信息</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th>记录类型：</th>
                                        <td>TXT</td>
                                    </tr>
                                    <tr>
                                        <th>主机记录：</th>
                                        <td>${data.records.name}</td>
                                    </tr>
                                    <tr>
                                        <th>记录值：</th>
                                        <td>
                                            <code>${data.records.value}</code>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${data.records.value}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('dns-records').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> 获取 DNS 记录失败：${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('dns-records').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> 获取 DNS 记录失败：${error}
                    </div>
                `;
            });
    }
});

// 初始化显示
document.addEventListener('DOMContentLoaded', function() {
    const sslProvider = document.getElementById('ssl-provider');
    const sslOperations = document.getElementById('ssl-operations');
    const letsencryptSection = document.getElementById('letsencrypt-section');
    const cloudflareSection = document.getElementById('cloudflare-section');
    
    if (sslProvider.value !== 'none') {
        sslOperations.style.display = 'block';
        if (sslProvider.value === 'letsencrypt') {
            letsencryptSection.style.display = 'block';
            cloudflareSection.style.display = 'none';
        } else if (sslProvider.value === 'cloudflare') {
            letsencryptSection.style.display = 'none';
            cloudflareSection.style.display = 'block';
        }
    }
    
    // 如果是 DNS 验证方式，显示验证信息
    const leValidation = document.getElementById('le-validation');
    if (leValidation && leValidation.value === 'dns') {
        document.getElementById('dns-validation-info').style.display = 'block';
    }
});

// 申请证书
function applyCertificate(url) {
    const provider = document.getElementById('ssl-provider').value;
    const validation = document.getElementById('le-validation')?.value || 'http';
    
    if (!confirm('确定要申请新证书吗？')) return;
    
    const formData = new FormData();
    formData.append('provider', provider);
    formData.append('validation', validation);
    
    if (provider === 'cloudflare') {
        const cert = document.querySelector('input[name="cloudflare_cert"]')?.files[0];
        const key = document.querySelector('input[name="cloudflare_key"]')?.files[0];
        if (!cert || !key) {
            alert('请选择证书文件和私钥文件');
            return;
        }
        formData.append('cert_file', cert);
        formData.append('key_file', key);
    }
    
    // 显示加载状态
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书申请成功！');
            location.reload();
        } else {
            alert('证书申请失败：' + data.error);
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
        // 恢复按钮状态
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// 更新证书
function renewCertificate(url) {
    if (!confirm('确定要更新证书吗？')) return;
    
    // 显示加载状态
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书更新成功！');
            location.reload();
        } else {
            alert('证书更新失败：' + data.error);
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
        // 恢复按钮状态
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// 删除证书
function revokeCertificate(url) {
    if (!confirm('确定要删除证书吗？此操作不可撤销！')) return;
    
    // 显示加载状态
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 删除中...';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书已删除！');
            location.reload();
        } else {
            alert('证书删除失败：' + data.error);
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
        // 恢复按钮状态
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// 复制到剪贴板
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('已复制到剪贴板！');
    }).catch(err => {
        alert('复制失败：' + err);
    });
}
</script>
{% endblock %}

