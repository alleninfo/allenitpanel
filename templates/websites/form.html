{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}编辑网站{% else %}添加网站{% endif %} - 控制面板{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% if form.instance.pk %}编辑网站{% else %}添加网站{% endif %}</h5>
                </div>
                <div class="card-body">
                    <form method="post" class="form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">网站名称</label>
                            {{ form.name }}
                            <div class="form-text">网站的名称，仅用于后台管理</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">域名</label>
                            {{ form.domain }}
                            <div class="form-text">网站的访问域名，例如：www.example.com</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">服务器类型</label>
                            {{ form.server_type }}
                            <div class="form-text">选择网站使用的Web服务器类型</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">端口</label>
                            <input type="number" name="port" class="form-control" value="{{ form.instance.port|default:'80' }}" min="1" max="65535">
                            <div class="form-text">网站访问端口，默认80</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">PHP版本</label>
                            <select name="php_version" class="form-control">
                                <option value="">不使用PHP</option>
                                {% for version in installed_php_versions %}
                                <option value="{{ version }}" {% if website.php_version == version %}selected{% endif %}>
                                    PHP {{ version }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">选择网站使用的PHP版本</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SSL 证书</label>
                            <select name="ssl_provider" class="form-control" id="ssl-provider">
                                <option value="none" {% if form.instance.ssl_provider == 'none' %}selected{% endif %}>不使用 SSL</option>
                                <option value="cloudflare" {% if form.instance.ssl_provider == 'cloudflare' %}selected{% endif %}>Cloudflare</option>
                                <option value="letsencrypt" {% if form.instance.ssl_provider == 'letsencrypt' %}selected{% endif %}>Let's Encrypt</option>
                            </select>
                            <div class="form-text">选择 SSL 证书提供商</div>
                        </div>

                        <!-- 证书状态和操作按钮 -->
                        <div id="ssl-operations" class="mb-3" style="display: none;">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3">SSL 证书管理</h6>
                                    
                                    <!-- 证书状态信息 -->
                                    <div id="cert-info" class="mb-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-info-circle"></i> 证书信息</h6>
                                            <div id="cert-details">
                                                <p><strong>状态：</strong> <span id="cert-status">{% if form.instance.ssl_enabled %}已启用{% else %}未启用{% endif %}</span></p>
                                                <p><strong>到期时间：</strong> <span id="cert-expiry">{{ cert_expiry|default:'未知' }}</span></p>
                                                <p><strong>域名：</strong> <span id="cert-domains">{{ form.instance.domain }}</span></p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cloudflare 证书上传 -->
                                    <div id="cloudflare-cert-section" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">证书文件 (CRT)</label>
                                            <input type="file" name="cloudflare_cert" class="form-control" accept=".crt,.pem">
                                            <div class="form-text">上传 Cloudflare 颁发的证书文件</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">私钥文件 (KEY)</label>
                                            <input type="file" name="cloudflare_key" class="form-control" accept=".key">
                                            <div class="form-text">上传证书对应的私钥文件</div>
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="uploadCloudflareSSL()">
                                            <i class="fas fa-upload"></i> 上传证书
                                        </button>
                                    </div>

                                    <!-- Let's Encrypt 证书配置 -->
                                    <div id="letsencrypt-cert-section" class="mb-3" style="display: none;">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-3">Let's Encrypt SSL 证书配置</h6>
                                                <div class="mb-3">
                                                    <label class="form-label">验证方式</label>
                                                    <select name="le_validation" class="form-control" id="le-validation">
                                                        <option value="http">HTTP 验证</option>
                                                        <option value="dns">DNS 验证</option>
                                                    </select>
                                                    <div class="form-text">选择域名所有权验证方式</div>
                                                </div>
                                                
                                                <!-- DNS 验证说明 -->
                                                <div id="dns-validation-info" class="alert alert-info mt-3" style="display: none;">
                                                    <h6><i class="fas fa-info-circle"></i> DNS 验证说明</h6>
                                                    <div id="dns-records" class="mt-3">
                                                        {% if form.instance.pk %}
                                                        <div class="text-center">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">加载中...</span>
                                                            </div>
                                                            <p class="mt-2">正在获取 DNS 验证记录...</p>
                                                        </div>
                                                        {% else %}
                                                        <div class="alert alert-warning">
                                                            <i class="fas fa-exclamation-triangle"></i> 请先保存网站信息，然后再配置 SSL 证书。
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 证书操作按钮 -->
                                    <div class="mt-3">
                                        {% if not form.instance.pk %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 请先保存网站信息，然后再配置 SSL 证书。
                                        </div>
                                        {% else %}
                                            {% if not form.instance.ssl_enabled %}
                                            <button type="button" class="btn btn-success" id="btn-apply-cert" onclick="applyCertificate('{% url "website_ssl_apply" form.instance.pk %}')">
                                                <i class="fas fa-plus"></i> 申请证书
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-warning" onclick="renewCertificate('{% url "website_ssl_renew" form.instance.pk %}')">
                                                <i class="fas fa-sync"></i> 更新证书
                                            </button>
                                            <button type="button" class="btn btn-danger" onclick="revokeCertificate('{% url "website_ssl_revoke" form.instance.pk %}')">
                                                <i class="fas fa-times"></i> 删除证书
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="additional-domains">
                            <label class="form-label">附加域名</label>
                            <div class="domain-list">
                                <!-- 动态添加的域名输入框将显示在这里 -->
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addDomainField()">
                                <i class="fas fa-plus"></i> 添加域名
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">保存</button>
                            <a href="{% url 'website_list' %}" class="btn btn-secondary">取消</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
function addDomainField() {
    const domainList = document.querySelector('.domain-list');
    const domainGroup = document.createElement('div');
    domainGroup.className = 'input-group mb-2';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'additional_domains[]';
    input.className = 'form-control';
    input.placeholder = '请输入域名';
    
    const btnGroup = document.createElement('div');
    btnGroup.className = 'input-group-append';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = function() {
        domainGroup.remove();
    };
    
    domainGroup.appendChild(input);
    domainGroup.appendChild(btnGroup);
    btnGroup.appendChild(removeBtn);
    domainList.appendChild(domainGroup);
}

// 如果是编辑模式，加载现有的附加域名
{% if form.instance.pk %}
{% for domain in form.instance.additional_domains.all %}
document.addEventListener('DOMContentLoaded', function() {
    const domainList = document.querySelector('.domain-list');
    const domainGroup = document.createElement('div');
    domainGroup.className = 'input-group mb-2';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'additional_domains[]';
    input.className = 'form-control';
    input.value = '{{ domain.domain }}';
    
    const btnGroup = document.createElement('div');
    btnGroup.className = 'input-group-append';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = function() {
        domainGroup.remove();
    };
    
    domainGroup.appendChild(input);
    domainGroup.appendChild(btnGroup);
    btnGroup.appendChild(removeBtn);
    domainList.appendChild(domainGroup);
});
{% endfor %}
{% endif %}

// SSL 提供商切换处理
document.getElementById('ssl-provider').addEventListener('change', function() {
    const sslOperations = document.getElementById('ssl-operations');
    const cloudflareSection = document.getElementById('cloudflare-cert-section');
    const letsencryptSection = document.getElementById('letsencrypt-cert-section');
    const certInfo = document.getElementById('cert-info');
    
    if (this.value === 'none') {
        sslOperations.style.display = 'none';
    } else {
        sslOperations.style.display = 'block';
        cloudflareSection.style.display = this.value === 'cloudflare' ? 'block' : 'none';
        letsencryptSection.style.display = this.value === 'letsencrypt' ? 'block' : 'none';
        
        {% if form.instance.pk and form.instance.ssl_enabled %}
        certInfo.style.display = 'block';
        {% endif %}
    }
});

// Let's Encrypt 验证方式切换
document.getElementById('le-validation').addEventListener('change', function() {
    const dnsInfo = document.getElementById('dns-validation-info');
    const recordsDiv = document.getElementById('dns-records');
    
    if (this.value === 'dns') {
        dnsInfo.style.display = 'block';
        {% if form.instance.pk %}
        recordsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在获取 DNS 验证记录...</p>
            </div>
        `;
        
        // 获取 DNS 验证记录
        fetch('{% url "website_ssl_dns_records" form.instance.pk %}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.records) {
                    recordsDiv.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">DNS 记录信息</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th>记录类型：</th>
                                        <td>TXT</td>
                                    </tr>
                                    <tr>
                                        <th>主机记录：</th>
                                        <td>${data.records.name}</td>
                                    </tr>
                                    <tr>
                                        <th>记录值：</th>
                                        <td>
                                            <code>${data.records.value}</code>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${data.records.value}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </table>
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle"></i> 重要提示：
                                    <ul class="mb-0">
                                        <li>请添加上述 DNS 记录到您的域名解析设置中</li>
                                        <li>等待记录生效后（通常需要几分钟到几小时）再申请证书</li>
                                        <li>您可以使用以下命令验证记录是否生效：</li>
                                    </ul>
                                    <pre class="mt-2 mb-0">dig -t txt _acme-challenge.${window.location.hostname}</pre>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    recordsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> 获取 DNS 记录失败：${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                recordsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> 获取 DNS 记录失败：${error}
                    </div>
                `;
            });
        {% else %}
        recordsDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 请先保存网站信息，然后再配置 SSL 证书。
            </div>
        `;
        {% endif %}
    } else {
        dnsInfo.style.display = 'none';
    }
});

// 申请证书
function applyCertificate(url) {
    const provider = document.getElementById('ssl-provider').value;
    const validation = document.getElementById('le-validation').value;
    
    if (!confirm('确定要申请新证书吗？')) return;
    
    const formData = new FormData();
    formData.append('provider', provider);
    formData.append('validation', validation);
    
    if (provider === 'cloudflare') {
        const cert = document.querySelector('input[name="cloudflare_cert"]').files[0];
        const key = document.querySelector('input[name="cloudflare_key"]').files[0];
        if (!cert || !key) {
            alert('请选择证书文件和私钥文件');
            return;
        }
        formData.append('cert_file', cert);
        formData.append('key_file', key);
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书申请成功！');
            location.reload();
        } else {
            alert('证书申请失败：' + data.error);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}

// 更新证书
function renewCertificate(url) {
    if (!confirm('确定要更新证书吗？')) return;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书更新成功！');
            location.reload();
        } else {
            alert('证书更新失败：' + data.error);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}

// 删除证书
function revokeCertificate(url) {
    if (!confirm('确定要删除证书吗？此操作不可撤销！')) return;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书已删除！');
            location.reload();
        } else {
            alert('证书删除失败：' + data.error);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}

// 复制到剪贴板
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('已复制到剪贴板！');
    }).catch(err => {
        alert('复制失败：' + err);
    });
}

// 上传 Cloudflare 证书
function uploadCloudflareSSL() {
    const cert = document.querySelector('input[name="cloudflare_cert"]').files[0];
    const key = document.querySelector('input[name="cloudflare_key"]').files[0];
    
    if (!cert || !key) {
        alert('请选择证书文件和私钥文件');
        return;
    }
    
    const formData = new FormData();
    formData.append('cert_file', cert);
    formData.append('key_file', key);
    
    fetch('{% url "website_ssl_upload" form.instance.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('证书上传成功！');
            location.reload();
        } else {
            alert('证书上传失败：' + data.error);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}

// 初始化显示
document.addEventListener('DOMContentLoaded', function() {
    const sslProvider = document.getElementById('ssl-provider');
    if (sslProvider.value !== 'none') {
        document.getElementById('ssl-operations').style.display = 'block';
        if (sslProvider.value === 'cloudflare') {
            document.getElementById('cloudflare-cert-section').style.display = 'block';
        } else if (sslProvider.value === 'letsencrypt') {
            document.getElementById('letsencrypt-cert-section').style.display = 'block';
        }
        
        {% if form.instance.pk and form.instance.ssl_enabled %}
        document.getElementById('cert-info').style.display = 'block';
        {% endif %}
    }
});
</script>
{% endblock %}
