{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">终端</h5>
        </div>
        <div class="card-body p-0">
            <div id="terminal"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'xterm/css/xterm.css' %}">
<style>
#terminal {
    height: calc(100vh - 200px);
    background: #000;
}
.terminal {
    padding: 10px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'xterm/lib/xterm.js' %}"></script>
<script src="{% static 'xterm/lib/xterm-addon-fit.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 创建终端
    const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'Menlo, Monaco, "Courier New", monospace',
        theme: {
            background: '#000000',
            foreground: '#ffffff'
        }
    });
    
    // 创建 FitAddon
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    
    // 打开终端
    term.open(document.getElementById('terminal'));
    fitAddon.fit();
    
    // 构建 WebSocket URL
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + window.location.host + '/ws/terminal/';
    
    // 连接 WebSocket
    function connectWebSocket() {
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            term.write('\r\n\x1B[1;3;32mConnected to terminal.\x1B[0m\r\n');
            // 发送终端大小
            ws.send(JSON.stringify({
                type: 'resize',
                cols: term.cols,
                rows: term.rows
            }));
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'terminal_output') {
                term.write(data.output);
            }
        };
        
        ws.onclose = function() {
            term.write('\r\n\x1B[1;3;31mConnection closed. Reconnecting...\x1B[0m\r\n');
            // 尝试重新连接
            setTimeout(connectWebSocket, 3000);
        };
        
        ws.onerror = function(e) {
            console.error('WebSocket error:', e);
            term.write('\r\n\x1B[1;3;31mWebSocket error occurred.\x1B[0m\r\n');
        };
        
        // 终端输入
        term.onData(function(data) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'terminal_input',
                    input: data
                }));
            }
        });
        
        // 窗口大小改变时调整终端大小
        window.addEventListener('resize', function() {
            fitAddon.fit();
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                }));
            }
        });
        
        return ws;
    }
    
    // 初始连接
    connectWebSocket();
});
</script>
{% endblock %} 